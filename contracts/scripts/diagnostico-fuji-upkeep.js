const { ethers } = require("hardhat");

async function main() {
    console.log("üîç DIAGN√ìSTICO COMPLETO - AVALANCHE FUJI UPKEEP");
    console.log("=".repeat(60));
    
    const CONTRACT_ADDRESS = "0x1B0B1A24983E51d809FBfAc424946B314fEFA271";
    const USDC_ADDRESS = "0x5425890298aed601595a70AB815c96711a31Bc65";
    
    console.log("üìç Contrato:", CONTRACT_ADDRESS);
    console.log("üèîÔ∏è Red: Avalanche Fuji Testnet");
    console.log("üîó Explorer: https://testnet.snowtrace.io/address/" + CONTRACT_ADDRESS);
    
    try {
        // Conectar al contrato
        const LottoMojiCore = await ethers.getContractFactory("LottoMojiCore");
        const contract = LottoMojiCore.attach(CONTRACT_ADDRESS);
        
        const [signer] = await ethers.getSigners();
        console.log("üë§ Cuenta conectada:", signer.address);
        
        // 1. VERIFICAR ESTADO B√ÅSICO DEL CONTRATO
        console.log("\nüéÆ 1. ESTADO B√ÅSICO DEL CONTRATO");
        console.log("-".repeat(45));
        
        const gameActive = await contract.gameActive();
        const automationActive = await contract.automationActive();
        const emergencyPause = await contract.emergencyPause();
        const currentGameDay = await contract.getCurrentDay();
        const ticketCounter = await contract.ticketCounter();
        
        console.log("üéÆ Game Active:", gameActive ? "‚úÖ S√ç" : "‚ùå NO");
        console.log("ü§ñ Automation Active:", automationActive ? "‚úÖ S√ç" : "‚ùå NO");
        console.log("‚è∏Ô∏è Emergency Pause:", emergencyPause ? "‚ùå S√ç" : "‚úÖ NO");
        console.log("üìÖ Current Game Day:", currentGameDay.toString());
        console.log("üé´ Tickets vendidos:", ticketCounter.toString());
        
        const basicProblems = [];
        if (!gameActive) basicProblems.push("Game no est√° activo");
        if (!automationActive) basicProblems.push("Automation no est√° activo");
        if (emergencyPause) basicProblems.push("Emergency pause est√° activado");
        
        if (basicProblems.length > 0) {
            console.log("‚ùå PROBLEMAS B√ÅSICOS:");
            basicProblems.forEach(problem => console.log("   - " + problem));
        } else {
            console.log("‚úÖ Configuraci√≥n b√°sica OK");
        }
        
        // 2. VERIFICAR CONFIGURACI√ìN DE TIEMPOS
        console.log("\n‚è∞ 2. CONFIGURACI√ìN DE TIEMPOS");
        console.log("-".repeat(35));
        
        const drawTimeUTC = await contract.drawTimeUTC();
        const drawInterval = await contract.DRAW_INTERVAL();
        const lastDrawTime = await contract.lastDrawTime();
        const totalDrawsExecuted = await contract.totalDrawsExecuted();
        
        const drawHour = Number(drawTimeUTC) / 3600;
        const intervalHours = Number(drawInterval) / 3600;
        const currentTime = Math.floor(Date.now() / 1000);
        const nextDrawTime = Number(lastDrawTime) + Number(drawInterval);
        const timeToNextDraw = nextDrawTime - currentTime;
        
        console.log("üïê Draw Time UTC:", drawHour + ":00");
        console.log("‚è≥ Draw Interval:", intervalHours + " horas");
        console.log("‚è∞ Last Draw Time:", new Date(Number(lastDrawTime) * 1000).toISOString());
        console.log("‚è∞ Next Draw Time:", new Date(nextDrawTime * 1000).toISOString());
        console.log("üéØ Total Draws Executed:", totalDrawsExecuted.toString());
        console.log("‚è≥ Time to Next Draw:", Math.max(0, timeToNextDraw), "segundos");
        
        if (timeToNextDraw > 0) {
            const hoursLeft = Math.floor(timeToNextDraw / 3600);
            const minutesLeft = Math.floor((timeToNextDraw % 3600) / 60);
            console.log("‚è∞ Tiempo restante:", hoursLeft + "h " + minutesLeft + "m");
        } else {
            console.log("üö® ¬°Ya es tiempo del sorteo!");
        }
        
        // 3. VERIFICAR UPKEEP
        console.log("\nüîÑ 3. VERIFICACI√ìN DE UPKEEP");
        console.log("-".repeat(35));
        
        try {
            const [upkeepNeeded, performData] = await contract.checkUpkeep("0x");
            console.log("üîÑ Upkeep Needed:", upkeepNeeded ? "‚úÖ S√ç" : "‚ùå NO");
            
            if (upkeepNeeded) {
                console.log("‚úÖ EL UPKEEP EST√Å LISTO PARA EJECUTARSE");
                console.log("ü§ñ Chainlink Automation deber√≠a ejecutarlo autom√°ticamente");
                
                if (performData !== "0x") {
                    try {
                        const decoded = ethers.AbiCoder.defaultAbiCoder().decode(['bool'], performData);
                        console.log("üìã Tipo de upkeep:", decoded[0] ? "SORTEO" : "DESCONOCIDO");
                    } catch (e) {
                        console.log("üìã Perform data:", performData);
                    }
                }
            } else {
                console.log("‚ùå EL UPKEEP NO EST√Å LISTO");
                console.log("üîç Posibles razones:");
                if (!automationActive) console.log("   - Automation est√° desactivado");
                if (emergencyPause) console.log("   - Emergency pause est√° activado");
                if (timeToNextDraw > 0) console.log("   - Todav√≠a no es tiempo del sorteo");
            }
        } catch (error) {
            console.log("‚ùå Error verificando upkeep:", error.message);
        }
        
        // 4. VERIFICAR CONFIGURACI√ìN VRF
        console.log("\nüé≤ 4. CONFIGURACI√ìN VRF");
        console.log("-".repeat(30));
        
        const subscriptionId = await contract.subscriptionId();
        console.log("üîó VRF Subscription ID:", subscriptionId.toString());
        console.log("üîó VRF Coordinator: 0x2eD832Ba664535e5886b75D64C46EB9a228C2610 (Avalanche Fuji)");
        console.log("üîë Key Hash: 0x354d2f95da55398f44b7cff77da56283d9c6c829a4bdf1bbcaf2ad6a4d081f61");
        console.log("‚è∞ Request Confirmations: 1 (Avalanche Fuji)");
        
        console.log("\nüí° VERIFICAR EN CHAINLINK:");
        console.log("üîó VRF Dashboard: https://vrf.chain.link/");
        console.log("üîó Automation Dashboard: https://automation.chain.link/");
        console.log("   - Cambiar a Avalanche Fuji");
        console.log("   - Verificar que la suscripci√≥n tenga fondos LINK");
        console.log("   - Verificar que el contrato est√© agregado como consumer");
        console.log("   - Verificar que haya un upkeep creado");
        
        // 5. VERIFICAR POOLS Y FINANCIAMIENTO
        console.log("\nüí∞ 5. ESTADO FINANCIERO");
        console.log("-".repeat(30));
        
        const mainPools = await contract.getMainPoolBalances();
        const reserves = await contract.getReserveBalances();
        const todaysPools = await contract.getDailyPoolInfo(currentGameDay);
        
        const totalMain = Number(mainPools.firstPrizeAccumulated) + 
                         Number(mainPools.secondPrizeAccumulated) + 
                         Number(mainPools.thirdPrizeAccumulated) + 
                         Number(mainPools.developmentAccumulated);
        
        const totalReserves = Number(reserves.firstPrizeReserve) + 
                             Number(reserves.secondPrizeReserve) + 
                             Number(reserves.thirdPrizeReserve);
        
        console.log("üí∞ Main Pools Total:", ethers.formatUnits(totalMain, 6), "USDC");
        console.log("üè¶ Reserve Pools Total:", ethers.formatUnits(totalReserves, 6), "USDC");
        console.log("üìÖ Today's Collection:", ethers.formatUnits(todaysPools.totalCollected, 6), "USDC");
        console.log("üéØ Today Distributed:", todaysPools.distributed ? "‚úÖ S√ç" : "‚ùå NO");
        console.log("üé≤ Today Drawn:", todaysPools.drawn ? "‚úÖ S√ç" : "‚ùå NO");
        
        // 6. DIAGN√ìSTICO FINAL Y RECOMENDACIONES
        console.log("\nüîß 6. DIAGN√ìSTICO Y RECOMENDACIONES");
        console.log("-".repeat(45));
        
        const issues = [];
        const solutions = [];
        
        if (!gameActive) {
            issues.push("Game no est√° activo");
            solutions.push("Activar game con funci√≥n de admin");
        }
        
        if (!automationActive) {
            issues.push("Automation no est√° activo");
            solutions.push("Activar automation con toggleAutomation()");
        }
        
        if (emergencyPause) {
            issues.push("Emergency pause activado");
            solutions.push("Desactivar emergency pause con toggleEmergencyPause()");
        }
        
        if (timeToNextDraw > 3600) {
            issues.push("Todav√≠a falta tiempo para el sorteo");
            solutions.push("Esperar hasta: " + new Date(nextDrawTime * 1000).toLocaleString());
        }
        
        if (Number(ticketCounter) === 0) {
            issues.push("No hay tickets comprados");
            solutions.push("Comprar tickets para activar el sistema");
        }
        
        if (!upkeepNeeded && timeToNextDraw <= 0) {
            issues.push("Upkeep no se activa aunque es tiempo de sorteo");
            solutions.push("Verificar configuraci√≥n de Chainlink Automation");
            solutions.push("Revisar suscripci√≥n VRF y fondos LINK");
            solutions.push("Considerar ejecutar sorteo manual");
        }
        
        if (issues.length === 0) {
            console.log("‚úÖ NO SE ENCONTRARON PROBLEMAS OBVIOS");
            console.log("ü§ñ El sistema deber√≠a funcionar autom√°ticamente");
            console.log("");
            console.log("üîç SI A√öN NO FUNCIONA, VERIFICAR:");
            console.log("1. üîó Chainlink Automation Dashboard");
            console.log("2. üí∞ Fondos LINK en la suscripci√≥n VRF");
            console.log("3. üìã Upkeep est√° creado y activo");
            console.log("4. üîó Contrato agregado como VRF consumer");
        } else {
            console.log("‚ùå PROBLEMAS ENCONTRADOS:");
            issues.forEach((issue, i) => {
                console.log(`   ${i + 1}. ${issue}`);
            });
            
            console.log("\nüîß SOLUCIONES RECOMENDADAS:");
            solutions.forEach((solution, i) => {
                console.log(`   ${i + 1}. ${solution}`);
            });
        }
        
        // 7. COMANDOS √öTILES
        console.log("\nüìã 7. COMANDOS √öTILES");
        console.log("-".repeat(25));
        console.log("# Activar automation:");
        console.log("npx hardhat run scripts/toggle-automation.js --network avalanche-fuji");
        console.log("");
        console.log("# Forzar sorteo manual:");
        console.log("npx hardhat run scripts/force-draw-fuji.js --network avalanche-fuji");
        console.log("");
        console.log("# Verificar estado:");
        console.log("npx hardhat run scripts/diagnostico-fuji-upkeep.js --network avalanche-fuji");
        
        console.log("\n" + "=".repeat(60));
        console.log("üîç DIAGN√ìSTICO COMPLETADO");
        console.log("=".repeat(60));
        
    } catch (error) {
        console.error("‚ùå Error durante el diagn√≥stico:", error.message);
        console.error("üìã Stack:", error.stack);
    }
}

main()
    .then(() => process.exit(0))
    .catch((error) => {
        console.error("üí• Error fatal:", error);
        process.exit(1);
    }); 